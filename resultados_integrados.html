<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados Integrados - Evaluaci√≥n Psicol√≥gica</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @media print {
            .result-section {
                border: 2px solid #3d4f2a !important;
                page-break-inside: avoid;
                background: #fff !important;
            }
            .result-section h3 {
                background: #eaf3e2;
                border-bottom: 2px solid #3d4f2a;
                margin: -8px -8px 8px -8px;
                padding: 6px 8px;
                font-size: 13px;
            }
            .chart-container {
                page-break-inside: avoid !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <span class="header-title">Resultados Integrados</span>
        </div>
        
        <div class="nav-bar no-print">
            <button class="nav-link" onclick="window.location.href='index.html'">Admisi√≥n ETE</button>
            <button class="nav-link" onclick="window.location.href='cbp_lrc_web.html'">CBP-LRC</button>
            <button class="nav-link" onclick="window.location.href='EQI-C.html'">EQI-C</button>
            <button class="nav-link" onclick="window.location.href='Valanti.html'">VALANTI</button>
            <button class="nav-link" onclick="window.location.href='Casa.html'">Test de la Casa</button>
        </div>

        <div style="width:100%;display:flex;justify-content:center;align-items:center;gap:15px;margin:15px 0;flex-wrap:wrap;" class="no-print">
            <button class="btn" style="background:#218838;padding:10px 20px;font-size:1.05rem;font-weight:bold;" onclick="descargarResultadosPDF()"><strong>üíæ DESCARGAR RESULTADOS</strong></button>
            <button class="btn" style="background:#555;padding:10px 20px;font-size:1.05rem;" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            <button class="btn" style="background:#b30000;padding:10px 20px;font-size:1.05rem;" onclick="limpiarResultados()">üóëÔ∏è Limpiar</button>
        </div>

        <div class="results-container">
            <!-- Informe Header (Visible only on print or screen as title) -->
            <div class="result-section" style="border:none;padding:0;margin-bottom:0 !important;background:#f0f5ed;border-radius:8px;padding:12px 0 !important;">
                <div style="display:flex;align-items:center;justify-content:center;gap:25px;margin-bottom:10px;padding:0 12px;">
                    <img src="PSIC.jpeg" alt="Logo Psicolog√≠a" style="height:60px;width:60px;object-fit:contain;">
                    <div style="flex:1;border-left:3px solid #3d4f2a;border-right:3px solid #3d4f2a;padding:0 20px;">
                        <h2 style="text-align:center;margin:5px 0;color:#3d4f2a;font-size:18px;font-weight:bold;letter-spacing:1px;">INFORME PSICOL√ìGICO INTEGRAL</h2>
                        <div style="text-align:center;font-size:11px;color:#666;margin-top:3px;">Evaluaci√≥n Integral de Competencias</div>
                    </div>
                    <img src="ETE.jpeg" alt="Logo ETE" style="height:60px;width:60px;object-fit:contain;">
                </div>
                <div id="datosPostulante" style="margin-bottom:8px;font-size:0.95em;padding:0 12px;"></div>
            </div>

            <div class="result-grid result-grid-screen">
                <!-- Columna 1 -->
                <div style="display:flex;flex-direction:column;gap:5px;">
                    <div class="result-section">
                        <h3 style="margin-top:0;">1. PERSONALIDAD (CBP-LRC)</h3>
                        <div id="cbpResultados" style="font-size:0.92em;"></div>
                        <div class="chart-container" style="margin-top:4px;height:240px;position:relative;"><canvas id="cbpChart" height="240"></canvas></div>
                    </div>
                   
                    <div class="result-section">
                        <h3 style="margin-top:0;">3. INTELIGENCIA EMOCIONAL (EQI-C)</h3>
                        <div id="eqiResultados" style="font-size:0.92em;"></div>
                        <div class="chart-container" style="margin-top:4px;height:240px;position:relative;"><canvas id="eqiChart" height="240"></canvas></div>
                    </div>
                </div>

                <!-- Columna 2 -->
                <div style="display:flex;flex-direction:column;gap:5px;">
                     <div class="result-section">
                        <h3 style="margin-top:0;">2. VALORES (VALANTI)</h3>
                        <div id="valantiResultados" style="font-size:0.92em;"></div>
                        <div class="chart-container" style="margin-top:4px;height:240px;position:relative;"><canvas id="valantiChart" height="240"></canvas></div>
                    </div>

                    <div class="result-section">
                        <h3 style="margin-top:0;">4. TEST DE LA CASA</h3>
                        <div id="casaResultados" style="font-size:0.93em;line-height:1.3;"></div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:20px;text-align:center;font-size:0.85em;color:#555;border-top:2px solid #3d4f2a;padding-top:12px;font-style:italic;">
                Este informe es confidencial y para uso exclusivo del Departamento de Psicolog√≠a.
            </div>
        </div>
    </div>
    <script>
    // Cargar datos personales desde localStorage
    function mostrarDatosPostulante(){
        let datos = {};
        try {
            if(localStorage.getItem('datosGenerales')) {
                datos = JSON.parse(localStorage.getItem('datosGenerales'));
            }
        } catch(e) { console.error("Error parsing datosGenerales", e); }

        const campos = [
            {label:'Apellidos', key:'apellidos'},
            {label:'Nombres', key:'nombres'},
            {label:'DNI', key:'dni'},
            {label:'Edad', key:'edad'},
            {label:'Sexo', key:'sexo'},
            {label:'C√≥digo', key:'codigo_postulante'}
        ];

        // Format for compact display (grid style)
        let html = '<div style="display:grid;grid-template-columns: repeat(3, 1fr); gap:6px; font-size:11px; border:2px solid #3d4f2a; padding:8px; border-radius:6px; background:#fdfeff;">';
        
        // Combine names if available
        let nombreCompleto = (datos['apellidos'] || '') + ' ' + (datos['nombres'] || '');
        if(!nombreCompleto.trim()) nombreCompleto = "No registrado";
        
        html += `<div style="grid-column: span 2; font-size:13px;border-bottom:1px solid #3d4f2a;padding-bottom:4px;"><strong>Apellidos y Nombres:</strong> ${nombreCompleto}</div>`;
        html += `<div style="font-size:11px;border-bottom:1px solid #3d4f2a;padding-bottom:4px;"><strong>DNI:</strong> ${datos['dni'] || '-'}</div>`;
        html += `<div style="font-size:11px;padding-top:4px;"><strong>Edad:</strong> ${datos['edad'] || '-'}</div>`;
        html += `<div style="font-size:13px;padding-top:4px;"><strong>Sexo:</strong> ${datos['sexo'] || '-'}</div>`;
        html += `<div style="font-size:13px;padding-top:4px;"><strong>C√≥d. Postulante:</strong> ${datos['codigo_postulante'] || '-'}</div>`;
        
        html += '</div>';
        document.getElementById('datosPostulante').innerHTML = html;
    }

    // Generic chart loader
    function loadChart(id, storageKey) {
        let chartDataStr = localStorage.getItem(storageKey);
        if(chartDataStr) {
            try {
                let chartData = JSON.parse(chartDataStr);
                
                // Mejorar opciones de visualizaci√≥n para print
                if(!chartData.options) {
                    chartData.options = {};
                }
                
                chartData.options.responsive = true;
                chartData.options.maintainAspectRatio = false;
                chartData.options.animation = false;
                
                // Mejorar tama√±o de fuentes
                if(chartData.options.plugins) {
                    if(!chartData.options.plugins.legend) chartData.options.plugins.legend = {};
                    chartData.options.plugins.legend.labels = chartData.options.plugins.legend.labels || {};
                    chartData.options.plugins.legend.labels.font = { size: 12, weight: '600' };
                }
                
                if(chartData.options.scales) {
                    if(chartData.options.scales.y) {
                        if(!chartData.options.scales.y.ticks) chartData.options.scales.y.ticks = {};
                        chartData.options.scales.y.ticks.font = { size: 11 };
                    }
                    if(chartData.options.scales.x) {
                        if(!chartData.options.scales.x.ticks) chartData.options.scales.x.ticks = {};
                        chartData.options.scales.x.ticks.font = { size: 11 };
                    }
                }

                let ctx = document.getElementById(id).getContext('2d');
                new Chart(ctx, chartData);
                document.getElementById(id).parentElement.style.display = 'block';
            } catch(e) { console.error("Error loading chart " + id, e); }
        } else {
             document.getElementById(id).parentElement.style.display = 'none';
        }
    }

    // Cargar resultados
    function cargarTodo() {
        mostrarDatosPostulante();
        
        // CBP
        document.getElementById('cbpResultados').innerHTML = localStorage.getItem('cbp_resultados') || '<p class="no-data">No se han registrado resultados.</p>';
        loadChart('cbpChart', 'cbp_chart');

        // EQI-C
        document.getElementById('eqiResultados').innerHTML = localStorage.getItem('eqi_resultados') || '<p class="no-data">No se han registrado resultados.</p>';
        // Correct key check from EQI-C.html (eqi_chart)
        loadChart('eqiChart', 'eqi_chart');

        // Valanti
        document.getElementById('valantiResultados').innerHTML = localStorage.getItem('valanti_resultados') || '<p class="no-data">No se han registrado resultados.</p>';
        loadChart('valantiChart', 'valanti_chart');

        // Casa
        document.getElementById('casaResultados').innerHTML = localStorage.getItem('casa_resultados') || '<p class="no-data">No se han registrado resultados.</p>';
    }

    window.addEventListener('DOMContentLoaded', cargarTodo);

    function limpiarResultados() {
        if(confirm("¬øEst√°s seguro de borrar todos los resultados almacenados?")) {
            localStorage.clear();
            location.reload();
        }
    }

    async function descargarResultadosPDF() {
        try {
            // Obtener datos del alumno
            let datos = {};
            if(localStorage.getItem('datosGenerales')) {
                datos = JSON.parse(localStorage.getItem('datosGenerales'));
            }
            
            let apellidos = (datos['apellidos'] || 'Resultados').toUpperCase().replace(/[\s\/\\:*?"<>|]/g, '_');
            let nombreArchivo = `Informe_Psicologico_${apellidos}_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}.pdf`;
            
            // Mostrar mensaje de proceso
            alert('Generando PDF... por favor espera.');
            
            // Obtener el elemento a convertir (excluir botones)
            const element = document.querySelector('.results-container');
            
            // Crear canvas desde HTML
            const canvas = await html2canvas(element, {
                scale: 2,
                allowTaint: true,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false
            });
            
            // Obtener dimensiones
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 295; // A4 height in mm
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // Crear PDF con jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            let heightLeft = imgHeight;
            let position = 0;
            
            const imgData = canvas.toDataURL('image/png');
            
            // Agregar im√°genes al PDF (una por p√°gina si es necesario)
            while (heightLeft >= 0) {
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                if (heightLeft > 0) {
                    pdf.addPage();
                    position = heightLeft - imgHeight;
                }
            }
            
            // Descargar PDF
            pdf.save(nombreArchivo);
            alert('‚úì PDF descargado correctamente: ' + nombreArchivo);
            
        } catch(e) {
            console.error("Error al generar PDF:", e);
            alert("‚ö†Ô∏è Error al generar el PDF.\n\nAlternativa: usa 'Imprimir' y guarda como PDF desde tu navegador.");
        }
    }
    </script>
</body>
</html>
